<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shape Network NFT Minter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 450px;
            width: 100%;
            text-align: center;
            max-height: 95vh;
            overflow-y: auto;
        }
        
        .logo {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 8px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            font-size: 1rem;
            margin-bottom: 20px;
            opacity: 0.8;
        }
        
        .status {
            margin: 15px 0;
            padding: 12px;
            border-radius: 10px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .status.disconnected {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.4);
        }
        
        .status.connected {
            background: rgba(78, 205, 196, 0.2);
            border: 1px solid rgba(78, 205, 196, 0.4);
        }
        
        .button {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            color: white;
            padding: 12px 25px;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 8px;
            display: inline-block;
            text-decoration: none;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .mint-form {
            margin-top: 20px;
            display: none;
        }
        
        .mint-form.active {
            display: block;
        }
        
        .form-group {
            margin: 15px 0;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
        }
        
        .form-group input::placeholder, .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .network-info {
            margin-top: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">🔷 Shape NFT</div>
        <div class="subtitle">Mint your NFT on Shape Network</div>
        
        <div id="status" class="status disconnected">
            Wallet not connected
        </div>
        
        <button id="connectButton" class="button">Connect Wallet</button>
        <button id="disconnectButton" class="button" style="display: none; background: linear-gradient(45deg, #e74c3c, #c0392b); margin-top: 10px;">Disconnect</button>
        
        <div id="mintForm" class="mint-form">
            <div class="form-group">
                <label for="tokenName">NFT Name:</label>
                <input type="text" id="tokenName" placeholder="My Awesome NFT" value="Shape Test NFT">
            </div>
            
            <div class="form-group">
                <label for="tokenDescription">Description:</label>
                <textarea id="tokenDescription" placeholder="Describe your NFT..." rows="3">A test NFT minted on Shape Network</textarea>
            </div>
            
            <div class="form-group">
                <label for="tokenImage">Image URL:</label>
                <input type="url" id="tokenImage" placeholder="https://example.com/image.png" value="https://via.placeholder.com/400x400/667eea/ffffff?text=Shape+NFT">
            </div>
            
            <button id="mintButton" class="button">Mint NFT</button>
        </div>
        
        <div class="network-info">
            <strong>🔷 Shape Network</strong><br>
            Ultra-low fees • Fast transactions
        </div>
        
        <div id="result"></div>
    </div>

    <script>
        // Shape Network configuration
        const SHAPE_NETWORK = {
            chainId: '0x168', // 360 in hex
            chainName: 'Shape Mainnet',
            nativeCurrency: {
                name: 'ETH',
                symbol: 'ETH',
                decimals: 18
            },
            rpcUrls: ['https://mainnet.shape.network'],
            blockExplorerUrls: ['https://explorer.shape.network']
        };

        // Diamond Collection contract ABI (ERC721)
        const NFT_ABI = [
            "function mintDiamond() public",
            "function hasAddressMinted(address user) public view returns (bool)",
            "function totalSupply() public view returns (uint256)",
            "function name() public view returns (string)",
            "function symbol() public view returns (string)",
            "function tokenURI(uint256 tokenId) public view returns (string)"
        ];

        let web3, account, contract;
        const contractAddress = "0x684325b47D05D0d1f44dCdE8dff47D2FcdABA7c2"; // Diamond Collection Contract

        // Initialize
        document.getElementById('connectButton').addEventListener('click', connectWallet);
        document.getElementById('disconnectButton').addEventListener('click', disconnectWallet);
        document.getElementById('mintButton').addEventListener('click', mintNFT);

        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    // Request account access
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    account = accounts[0];
                    
                    // Switch to Shape Network
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: SHAPE_NETWORK.chainId }],
                        });
                    } catch (switchError) {
                        // This error code indicates that the chain has not been added to MetaMask
                        if (switchError.code === 4902) {
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [SHAPE_NETWORK],
                                });
                            } catch (addError) {
                                console.error('Failed to add network:', addError);
                                updateStatus('Failed to add Shape Network', 'disconnected');
                                return;
                            }
                        } else {
                            console.error('Failed to switch network:', switchError);
                            updateStatus('Failed to switch to Shape Network', 'disconnected');
                            return;
                        }
                    }
                    
                    // Initialize web3
                    web3 = new ethers.providers.Web3Provider(window.ethereum);
                    
                    updateStatus(`Connected: ${account.slice(0, 6)}...${account.slice(-4)}`, 'connected');
                    document.getElementById('connectButton').style.display = 'none';
                    document.getElementById('disconnectButton').style.display = 'inline-block';
                    document.getElementById('mintForm').classList.add('active');
                    document.getElementById('result').innerHTML = ''; // Clear any previous messages
                    
                } catch (error) {
                    console.error('Failed to connect wallet:', error);
                    updateStatus('Failed to connect wallet', 'disconnected');
                }
            } else {
                updateStatus('Please install MetaMask or another Web3 wallet', 'disconnected');
            }
        }

        async function disconnectWallet() {
            try {
                // Try to revoke permissions (MetaMask and compatible wallets)
                if (window.ethereum && window.ethereum.request) {
                    try {
                        await window.ethereum.request({
                            method: "wallet_revokePermissions",
                            params: [{ eth_accounts: {} }]
                        });
                    } catch (revokeError) {
                        // This method might not be supported by all wallets
                        console.log("Revoke permissions not supported:", revokeError.message);
                    }
                }
                
            } catch (error) {
                console.log("Wallet disconnect not fully supported:", error.message);
                // Continue with local cleanup even if wallet disconnect fails
            }
            
            // Clear local state regardless of wallet disconnect success
            account = null;
            web3 = null;
            contract = null;
            
            updateStatus('Wallet disconnected', 'disconnected');
            document.getElementById('connectButton').style.display = 'inline-block';
            document.getElementById('disconnectButton').style.display = 'none';
            document.getElementById('mintForm').classList.remove('active');
            document.getElementById('result').innerHTML = '';
            
            // Show helpful message about true disconnection
            showResult('🔓 Wallet Disconnected', `
                <p><strong>Local session cleared!</strong></p>
                <p>If you want to connect a different wallet account:</p>
                <ol style="text-align: left; margin-left: 20px; margin-top: 10px;">
                    <li>Open your wallet (MetaMask)</li>
                    <li>Switch to the desired account</li>
                    <li>Then click "Connect Wallet" again</li>
                </ol>
                <p style="margin-top: 10px; font-size: 0.8em; opacity: 0.8;">
                    Note: Some wallets may remember this site's connection. 
                    The steps above ensure you can select a different account.
                </p>
            `);
        }

        async function mintNFT() {
            if (!account) {
                updateStatus('Please connect your wallet first', 'disconnected');
                return;
            }

            const mintButton = document.getElementById('mintButton');
            const originalText = mintButton.textContent;
            
            try {
                mintButton.innerHTML = '<span class="loading"></span>Minting...';
                mintButton.disabled = true;

                // Initialize contract if not already done
                if (!contract) {
                    const signer = web3.getSigner();
                    contract = new ethers.Contract(contractAddress, NFT_ABI, signer);
                }

                // Check if user has already minted
                const hasAlreadyMinted = await contract.hasAddressMinted(account);
                if (hasAlreadyMinted) {
                    showResult('💎 You Already Own a Diamond!', 'Great news! You already have your unique Diamond NFT in your collection. Each wallet can only mint one Diamond to keep them special and exclusive.');
                    return;
                }

                // Call the mintDiamond function
                const tx = await contract.mintDiamond();
                
                showResult('⏳ Minting in Progress', `
                    <p>Your Diamond is being created!</p>
                    <p>Please wait while we confirm your transaction...</p>
                `);

                // Wait for transaction confirmation
                const receipt = await tx.wait();
                
                // Get the token ID from the event
                const event = receipt.events?.find(e => e.event === 'DiamondMinted');
                const tokenId = event?.args?.tokenId?.toString();

                showResult('✅ Diamond Minted!', `
                    <p><strong>Congratulations! 💎</strong></p>
                    <p>Your Diamond NFT has been minted successfully!</p>
                    ${tokenId ? `<p><strong>Diamond #${tokenId}</strong></p>` : ''}
                    <p><a href="https://explorer.shape.network/tx/${tx.hash}" target="_blank" style="color: #4ecdc4; text-decoration: none;">
                        🔍 View Transaction Details
                    </a></p>
                `);

            } catch (error) {
                console.error('Minting failed:', error);
                let errorMessage = error.message;
                
                if (error.message.includes('You have already minted')) {
                    errorMessage = 'You have already minted your Diamond NFT!';
                } else if (error.message.includes('user rejected')) {
                    errorMessage = 'Transaction was cancelled by user.';
                }
                
                showResult('❌ Minting Failed', errorMessage);
            } finally {
                mintButton.textContent = originalText;
                mintButton.disabled = false;
            }
        }

        function updateStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function showResult(title, message) {
            const result = document.getElementById('result');
            result.innerHTML = `
                <div style="margin-top: 20px; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; text-align: left;">
                    <h3 style="margin-bottom: 10px;">${title}</h3>
                    <div>${message}</div>
                </div>
            `;
        }

        // Check if wallet is already connected
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined') {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    account = accounts[0];
                    web3 = new ethers.providers.Web3Provider(window.ethereum);
                    updateStatus(`Connected: ${account.slice(0, 6)}...${account.slice(-4)}`, 'connected');
                    document.getElementById('connectButton').style.display = 'none';
                    document.getElementById('disconnectButton').style.display = 'inline-block';
                    document.getElementById('mintForm').classList.add('active');
                }
            }
        });
    </script>
    
    <!-- Include ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</body>
</html>
